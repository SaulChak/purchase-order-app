<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order & Inventory Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            border-color: #4facfe;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #4facfe;
            padding-bottom: 10px;
        }

        .upload-area {
            border: 3px dashed #4facfe;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #00f2fe;
            transform: scale(1.02);
        }

        .upload-area.dragover {
            background: linear-gradient(135deg, #e8f4fd 0%, #d0e8ff 100%);
            border-color: #00f2fe;
        }

        .upload-icon {
            font-size: 3em;
            color: #4facfe;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: rgba(79, 172, 254, 0.1);
        }

        .mapping-row {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .mapping-row:hover {
            border-color: #4facfe;
        }

        .status-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-processed {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.3s ease;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid transparent;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f1b0b7;
        }

        .hidden {
            display: none;
        }

        .flex {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .flex-column {
            flex-direction: column;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Purchase Order & Inventory Manager</h1>
            <p>Streamline your order processing and inventory management workflow</p>
        </div>

        <div class="main-content">
            <!-- Statistics Dashboard -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalPOs">0</h3>
                    <p>Purchase Orders</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalItems">0</h3>
                    <p>Inventory Items</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalMapped">0</h3>
                    <p>Items Mapped</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalValue">$0</h3>
                    <p>Total PO Value</p>
                </div>
            </div>

            <!-- Inventory Management Section -->
            <div class="section">
                <h2>üè™ Inventory Management</h2>
                <div class="flex">
                    <div class="form-group" style="flex: 1;">
                        <label for="itemSku">SKU/Part Number</label>
                        <input type="text" id="itemSku" placeholder="Enter SKU or part number">
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label for="itemName">Item Name</label>
                        <input type="text" id="itemName" placeholder="Enter item name/description">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="itemPrice">Unit Price</label>
                        <input type="number" id="itemPrice" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="itemStock">Stock Qty</label>
                        <input type="number" id="itemStock" placeholder="0">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addInventoryItem()">Add Item</button>
                <button class="btn btn-success" onclick="exportInventory()">Export Inventory</button>
                <button class="btn" onclick="importInventory()">Import Inventory</button>
                <input type="file" id="inventoryFile" accept=".csv" style="display: none;" onchange="handleInventoryImport(event)">
                
                <div id="inventoryContainer" class="table-container" style="margin-top: 20px;">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Item Name</th>
                                <th>Unit Price</th>
                                <th>Stock Qty</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PDF Upload Section -->
            <div class="section">
                <h2>üìÑ Upload Purchase Orders</h2>
                <div class="upload-area" id="pdfUploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Drop PDF files here or click to select</h3>
                    <p>Upload multiple PDF purchase orders to process</p>
                    <input type="file" id="pdfInput" multiple accept=".pdf" style="display: none;">
                </div>
                <div class="progress-bar hidden" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="pdfResults" class="hidden">
                    <h3>Extracted Purchase Orders</h3>
                    <div id="pdfResultsContent"></div>
                </div>
            </div>

            <!-- Item Mapping Section -->
            <div class="section hidden" id="mappingSection">
                <h2>üîó Item Mapping</h2>
                <div class="alert alert-info">
                    <strong>Map Customer Items to Your Inventory:</strong> Match items from purchase orders to your inventory items for accurate processing.
                </div>
                <div id="mappingContainer"></div>
                <button class="btn btn-primary" onclick="saveMappings()">Save Mappings</button>
                <button class="btn btn-success" onclick="autoMapItems()">Auto-Map Similar Items</button>
            </div>

            <!-- Export Section -->
            <div class="section hidden" id="exportSection">
                <h2>üì§ Export to NetSuite</h2>
                <div class="alert alert-success">
                    <strong>Ready to Export:</strong> Your purchase orders have been processed and are ready for NetSuite import.
                </div>
                <div class="flex">
                    <button class="btn btn-primary" onclick="exportToNetSuite()">Export CSV for NetSuite</button>
                    <button class="btn" onclick="previewExport()">Preview Export Data</button>
                </div>
                <div id="exportPreview" class="hidden">
                    <h3>Export Preview</h3>
                    <div class="table-container">
                        <table id="exportTable">
                            <thead id="exportTableHead"></thead>
                            <tbody id="exportTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let inventory = [];
        let purchaseOrders = [];
        let mappings = {};
        let processedOrders = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadInventoryFromStorage();
            loadMappingsFromStorage();
            setupEventListeners();
            updateStats();
        });

        function setupEventListeners() {
            // PDF upload area
            const uploadArea = document.getElementById('pdfUploadArea');
            const pdfInput = document.getElementById('pdfInput');

            uploadArea.addEventListener('click', () => pdfInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            pdfInput.addEventListener('change', handleFileSelect);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            processPDFFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            processPDFFiles(files);
        }

        // Inventory Management Functions
        function addInventoryItem() {
            const sku = document.getElementById('itemSku').value.trim();
            const name = document.getElementById('itemName').value.trim();
            const price = parseFloat(document.getElementById('itemPrice').value) || 0;
            const stock = parseInt(document.getElementById('itemStock').value) || 0;

            if (!sku || !name) {
                alert('Please enter both SKU and Item Name');
                return;
            }

            // Check if SKU already exists
            if (inventory.find(item => item.sku === sku)) {
                alert('SKU already exists!');
                return;
            }

            const item = {
                sku: sku,
                name: name,
                price: price,
                stock: stock,
                id: Date.now()
            };

            inventory.push(item);
            saveInventoryToStorage();
            updateInventoryTable();
            updateStats();
            clearInventoryForm();
        }

        function clearInventoryForm() {
            document.getElementById('itemSku').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemStock').value = '';
        }

        function updateInventoryTable() {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';

            inventory.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.sku}</td>
                    <td>${item.name}</td>
                    <td>$${item.price.toFixed(2)}</td>
                    <td>${item.stock}</td>
                    <td>
                        <button class="btn btn-danger" onclick="removeInventoryItem(${item.id})">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function removeInventoryItem(itemId) {
            inventory = inventory.filter(item => item.id !== itemId);
            saveInventoryToStorage();
            updateInventoryTable();
            updateStats();
        }

        function exportInventory() {
            let csvContent;
            
            // Check if Papa is available for better CSV formatting
            if (typeof Papa !== 'undefined') {
                csvContent = Papa.unparse(inventory.map(item => ({
                    SKU: item.sku,
                    'Item Name': item.name,
                    'Unit Price': item.price,
                    'Stock Quantity': item.stock
                })));
            } else {
                // Fallback CSV creation
                const headers = ['SKU', 'Item Name', 'Unit Price', 'Stock Quantity'];
                const rows = inventory.map(item => [
                    item.sku,
                    item.name,
                    item.price,
                    item.stock
                ]);
                
                csvContent = headers.join(',') + '\n' + 
                    rows.map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            }

            downloadCSV(csvContent, 'inventory_export.csv');
        }

        function importInventory() {
            document.getElementById('inventoryFile').click();
        }

        function handleInventoryImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    
                    // Check if Papa is loaded
                    if (typeof Papa === 'undefined') {
                        // Fallback CSV parsing if Papa isn't available
                        const lines = csv.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                        
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                            if (values.length >= headers.length && values[0]) {
                                const row = {};
                                headers.forEach((header, index) => {
                                    row[header] = values[index] || '';
                                });
                                
                                const sku = row.SKU || row.sku;
                                const name = row['Item Name'] || row.name || row.description;
                                const price = parseFloat(row['Unit Price'] || row.price) || 0;
                                const stock = parseInt(row['Stock Quantity'] || row.stock || row.quantity) || 0;

                                if (sku && name && !inventory.find(item => item.sku === sku)) {
                                    inventory.push({
                                        sku: sku,
                                        name: name,
                                        price: price,
                                        stock: stock,
                                        id: Date.now() + Math.random()
                                    });
                                }
                            }
                        }
                    } else {
                        // Use Papa Parse if available
                        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
                        
                        parsed.data.forEach(row => {
                            const sku = row.SKU || row.sku;
                            const name = row['Item Name'] || row.name || row.description;
                            const price = parseFloat(row['Unit Price'] || row.price) || 0;
                            const stock = parseInt(row['Stock Quantity'] || row.stock || row.quantity) || 0;

                            if (sku && name && !inventory.find(item => item.sku === sku)) {
                                inventory.push({
                                    sku: sku,
                                    name: name,
                                    price: price,
                                    stock: stock,
                                    id: Date.now() + Math.random()
                                });
                            }
                        });
                    }

                    saveInventoryToStorage();
                    updateInventoryTable();
                    updateStats();
                    alert('Inventory imported successfully!');
                } catch (error) {
                    alert('Error importing inventory: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // PDF Processing Functions
        async function processPDFFiles(files) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const resultsDiv = document.getElementById('pdfResults');
            const resultsContent = document.getElementById('pdfResultsContent');

            progressBar.classList.remove('hidden');
            resultsDiv.classList.add('hidden');
            purchaseOrders = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const progress = ((i + 1) / files.length) * 100;
                progressFill.style.width = progress + '%';

                try {
                    const pdfData = await extractPDFData(file);
                    purchaseOrders.push(pdfData);
                } catch (error) {
                    console.error('Error processing PDF:', error);
                }
            }

            progressBar.classList.add('hidden');
            displayPDFResults();
            updateStats();
        }

        async function extractPDFData(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const typedArray = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument(typedArray).promise;
                        let fullText = '';

                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText + ' ';
                        }

                        const parsedData = parsePurchaseOrderText(fullText, file.name);
                        resolve(parsedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function parsePurchaseOrderText(text, filename) {
            // Basic parsing logic - this can be enhanced based on your PDF formats
            const lines = text.split('\n').filter(line => line.trim());
            
            const poData = {
                filename: filename,
                poNumber: extractPONumber(text),
                customer: extractCustomer(text),
                date: extractDate(text),
                items: extractItems(text),
                total: 0
            };

            // Calculate total
            poData.total = poData.items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);

            return poData;
        }

        function extractPONumber(text) {
            const poMatches = text.match(/(?:PO|Purchase Order|P\.O\.)\s*#?\s*:?\s*([A-Z0-9\-]+)/i);
            return poMatches ? poMatches[1] : 'Unknown';
        }

        function extractCustomer(text) {
            const customerMatches = text.match(/(?:Customer|Client|Company|Bill To|Ship To):\s*([^\n]+)/i);
            return customerMatches ? customerMatches[1].trim() : 'Unknown Customer';
        }

        function extractDate(text) {
            const dateMatches = text.match(/(?:Date|Order Date):\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/i);
            return dateMatches ? dateMatches[1] : new Date().toLocaleDateString();
        }

        function extractItems(text) {
            const items = [];
            const lines = text.split('\n');
            
            // Simple item extraction - looks for patterns like quantity, description, price
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Look for lines that might contain item information
                const itemMatch = line.match(/(\d+)\s+(.+?)\s+\$?(\d+\.?\d*)/);
                if (itemMatch) {
                    const quantity = parseInt(itemMatch[1]);
                    const description = itemMatch[2].trim();
                    const unitPrice = parseFloat(itemMatch[3]);
                    
                    if (quantity > 0 && unitPrice > 0) {
                        items.push({
                            quantity: quantity,
                            description: description,
                            unitPrice: unitPrice,
                            total: quantity * unitPrice
                        });
                    }
                }
            }

            // If no items found, create sample items for demonstration
            if (items.length === 0) {
                items.push({
                    quantity: 1,
                    description: 'Sample Item (extracted from PDF)',
                    unitPrice: 10.00,
                    total: 10.00
                });
            }

            return items;
        }

        function displayPDFResults() {
            const resultsDiv = document.getElementById('pdfResults');
            const resultsContent = document.getElementById('pdfResultsContent');

            if (purchaseOrders.length === 0) {
                resultsContent.innerHTML = '<p>No purchase orders were processed.</p>';
                return;
            }

            let html = '';
            purchaseOrders.forEach((po, index) => {
                html += `
                    <div class="section" style="margin-bottom: 20px;">
                        <h3>PO #${po.poNumber} - ${po.customer}</h3>
                        <p><strong>File:</strong> ${po.filename}</p>
                        <p><strong>Date:</strong> ${po.date}</p>
                        <p><strong>Total:</strong> $${po.total.toFixed(2)}</p>
                        <h4>Items:</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Qty</th>
                                        <th>Description</th>
                                        <th>Unit Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${po.items.map(item => `
                                        <tr>
                                            <td>${item.quantity}</td>
                                            <td>${item.description}</td>
                                            <td>$${item.unitPrice.toFixed(2)}</td>
                                            <td>$${item.total.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            resultsContent.innerHTML = html;
            resultsDiv.classList.remove('hidden');
            document.getElementById('mappingSection').classList.remove('hidden');
            createMappingInterface();
        }

        // Item Mapping Functions
        function createMappingInterface() {
            const mappingContainer = document.getElementById('mappingContainer');
            mappingContainer.innerHTML = '';

            const allItems = [];
            purchaseOrders.forEach(po => {
                po.items.forEach(item => {
                    allItems.push({
                        ...item,
                        poNumber: po.poNumber,
                        customer: po.customer
                    });
                });
            });

            allItems.forEach((item, index) => {
                const mappingRow = document.createElement('div');
                mappingRow.className = 'mapping-row';
                mappingRow.innerHTML = `
                    <div style="flex: 2;">
                        <strong>Customer Item:</strong><br>
                        ${item.description}<br>
                        <small>PO: ${item.poNumber} | Qty: ${item.quantity}</small>
                    </div>
                    <div style="flex: 1;">
                        <strong>Map to Inventory:</strong><br>
                        <select id="mapping_${index}" onchange="updateMapping(${index}, this.value)">
                            <option value="">Select inventory item...</option>
                            ${inventory.map(invItem => `
                                <option value="${invItem.sku}" ${mappings[item.description] === invItem.sku ? 'selected' : ''}>
                                    ${invItem.sku} - ${invItem.name}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <strong>Status:</strong><br>
                        <span class="status-indicator ${mappings[item.description] ? 'status-processed' : 'status-pending'}">
                            ${mappings[item.description] ? 'Mapped' : 'Pending'}
                        </span>
                    </div>
                `;
                mappingContainer.appendChild(mappingRow);
            });
        }

        function updateMapping(index, inventorySku) {
            const customerItem = getAllCustomerItems()[index];
            if (inventorySku) {
                mappings[customerItem.description] = inventorySku;
            } else {
                delete mappings[customerItem.description];
            }
            saveMappingsToStorage();
            updateStats();
        }

        function getAllCustomerItems() {
            const allItems = [];
            purchaseOrders.forEach(po => {
                po.items.forEach(item => {
                    allItems.push({
                        ...item,
                        poNumber: po.poNumber,
                        customer: po.customer
                    });
                });
            });
            return allItems;
        }

        function autoMapItems() {
            const allItems = getAllCustomerItems();
            let mappedCount = 0;

            allItems.forEach(customerItem => {
                if (!mappings[customerItem.description]) {
                    // Try to find similar items in inventory
                    const similarItem = inventory.find(invItem => 
                        invItem.name.toLowerCase().includes(customerItem.description.toLowerCase()) ||
                        customerItem.description.toLowerCase().includes(invItem.name.toLowerCase())
                    );

                    if (similarItem) {
                        mappings[customerItem.description] = similarItem.sku;
                        mappedCount++;
                    }
                }
            });

            if (mappedCount > 0) {
                saveMappingsToStorage();
                createMappingInterface();
                updateStats();
                alert(`Auto-mapped ${mappedCount} items!`);
            } else {
                alert('No similar items found for auto-mapping.');
            }
        }

        function saveMappings() {
            saveMappingsToStorage();
            document.getElementById('exportSection').classList.remove('hidden');
            alert('Mappings saved successfully!');
        }

        // Export Functions
        function exportToNetSuite() {
            const exportData = prepareNetSuiteData();
            let csvContent;
            
            // Check if Papa is available
            if (typeof Papa !== 'undefined') {
                csvContent = Papa.unparse(exportData);
            } else {
                // Fallback CSV creation
                if (exportData.length === 0) {
                    alert('No data to export');
                    return;
                }
                
                const headers = Object.keys(exportData[0]);
                const rows = exportData.map(row => headers.map(header => row[header]));
                
                csvContent = headers.join(',') + '\n' + 
                    rows.map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            }
            
            downloadCSV(csvContent, 'netsuite_import.csv');
        }

        function prepareNetSuiteData() {
            const exportData = [];
            
            purchaseOrders.forEach(po => {
                po.items.forEach(item => {
                    const inventoryItem = inventory.find(inv => inv.sku === mappings[item.description]);
                    
                    exportData.push({
                        'PO Number': po.poNumber,
                        'Customer': po.customer,
                        'Date': po.date,
                        'Item SKU': inventoryItem ? inventoryItem.sku : 'UNMAPPED',
                        'Item Name': inventoryItem ? inventoryItem.name : item.description,
                        'Customer Description': item.description,
                        'Quantity': item.quantity,
                        'Unit Price': inventoryItem ? inventoryItem.price : item.unitPrice,
                        'Total': item.quantity * (inventoryItem ? inventoryItem.price : item.unitPrice),
                        'Status': inventoryItem ? 'Mapped' : 'Unmapped'
                    });
                });
            });

            return exportData;
        }

        function previewExport() {
            const exportData = prepareNetSuiteData();
            const previewDiv = document.getElementById('exportPreview');
            const table = document.getElementById('exportTable');
            const thead = document.getElementById('exportTableHead');
            const tbody = document.getElementById('exportTableBody');

            if (exportData.length === 0) {
                previewDiv.innerHTML = '<p>No data to preview.</p>';
                return;
            }

            // Create header
            const headers = Object.keys(exportData[0]);
            thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

            // Create body
            tbody.innerHTML = exportData.map(row => 
                `<tr>${headers.map(h => `<td>${row[h]}</td>`).join('')}</tr>`
            ).join('');

            previewDiv.classList.remove('hidden');
        }

        // Utility Functions
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function updateStats() {
            document.getElementById('totalPOs').textContent = purchaseOrders.length;
            document.getElementById('totalItems').textContent = inventory.length;
            document.getElementById('totalMapped').textContent = Object.keys(mappings).length;
            
            const totalValue = purchaseOrders.reduce((sum, po) => sum + po.total, 0);
            document.getElementById('totalValue').textContent = '$' + totalValue.toFixed(2);
        }

        // Storage Functions
        function saveInventoryToStorage() {
            const data = JSON.stringify(inventory);
            // Using variable instead of localStorage for compatibility
            window.inventoryData = data;
        }

        function loadInventoryFromStorage() {
            try {
                const data = window.inventoryData;
                if (data) {
                    inventory = JSON.parse(data);
                    updateInventoryTable();
                }
            } catch (error) {
                console.error('Error loading inventory:', error);
            }
        }

        function saveMappingsToStorage() {
            const data = JSON.stringify(mappings);
            window.mappingsData = data;
        }

        function loadMappingsFromStorage() {
            try {
                const data = window.mappingsData;
                if (data) {
                    mappings = JSON.parse(data);
                }
            } catch (error) {
                console.error('Error loading mappings:', error);
            }
        }
    </script>
</body>
</html>
